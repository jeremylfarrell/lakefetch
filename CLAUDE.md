# lakefetch

R package for calculating fetch (open water distance) and wave exposure metrics for lake sampling points. Uses ray-casting to measure directional fetch from site locations to shorelines, with optional integration of hydrological context from NHD and historical weather data for wave energy calculations.

## Project Structure

```
fetch/
├── R/                      # Package source code
│   ├── bathymetry.R        # Lake depth estimation (empirical relationships)
│   ├── data_loading.R      # Site data loading and validation (load_sites)
│   ├── fetch_core.R        # Core fetch calculation (fetch_calculate, ray-casting)
│   ├── globals.R           # Package options and defaults (lakefetch_options)
│   ├── lake_sources.R      # Lake boundary acquisition (OSM download with fallback)
│   ├── nhd_integration.R   # NHD hydrological context (outlets, inlets, watershed)
│   ├── shiny_app.R         # Interactive Shiny visualization apps
│   ├── visualization.R     # Static plots (map, bar chart, rose diagram)
│   ├── weather_integration.R # Historical weather from Open-Meteo API
│   └── zzz.R               # Package load hooks and global variables
├── tests/                  # Test suite
│   └── testthat/
│       ├── helper-geometries.R    # Shared test helpers (synthetic lakes)
│       ├── test-fetch_core.R      # Core algorithm tests (18 tests)
│       ├── test-data_loading.R    # Input handling tests (25 tests)
│       ├── test-options.R         # Configuration tests (24 tests)
│       └── test-visualization.R   # Plotting tests (12 tests)
├── inst/
│   └── validation/
│       ├── validate_fetch.R       # Analytical validation script
│       └── VALIDATION_SUMMARY.md  # Validation results documentation
├── man/                    # Generated documentation (roxygen2)
├── vignettes/              # Package vignettes
├── DESCRIPTION             # Package metadata and dependencies
├── NAMESPACE               # Exported functions (generated by roxygen2)
├── LICENSE                 # MIT license
└── TODO.md                 # Development roadmap and pending tasks
```

## Core Workflow

```r
library(lakefetch)

# 1. Load site data (CSV with lat/lon columns)
sites <- load_sites("sites.csv")

# 2. Get lake boundary (from OSM or local file)
lake <- get_lake_boundary(sites)
# or: lake <- get_lake_boundary(sites, file = "boundary.shp")

# 3. Calculate fetch
results <- fetch_calculate(sites, lake)

# 4. Visualize
plot_fetch_map(results)      # Map with exposure categories
plot_fetch_bars(results)     # Bar chart of effective fetch
fetch_app(results)           # Interactive Shiny app
```

## Key Functions

### Data Loading
- `load_sites(x)` - Load from CSV file or data.frame; auto-detects lat/lon columns
- Preserves `lake.name` column for name-based lake matching
- `sanitize_filename(name)` - Clean strings for safe filenames

### Lake Boundaries
- `get_lake_boundary(sites, file)` - Download from OSM or load local shapefile
- Uses multiple Overpass API servers with automatic failover for reliability
- Supports name-based matching when spatial intersection fails
- `assign_sites_to_lakes(sites_sf, water_polygons)` - Spatial join sites to lakes

### Fetch Calculation
- `fetch_calculate(sites, lake, add_context)` - Main entry point; returns list with results, lakes, angles
- `create_ray_geometries(fetch_data)` - Generate ray lines for visualization

### Depth Estimation
- `get_lake_depth(lake_polygon, user_depth, method)` - Estimate from empirical relationships
- `add_lake_depth(fetch_results, lake_polygons)` - Add depth column to results
- Note: HydroLAKES integration disabled (hydrolinks not on CRAN)

### NHD Integration
- `add_lake_context(fetch_results, lake_polygons, utm_epsg)` - Add outlet/inlet distances, watershed area, connectivity

### Weather Integration
- `add_weather_context(fetch_results, datetime_col, windows_hours)` - Add historical weather and wave energy metrics

### Visualization
- `plot_fetch_map(fetch_data)` - ggplot2 map colored by exposure
- `plot_fetch_bars(fetch_data)` - Bar chart of effective fetch
- `plot_fetch_rose(fetch_data, site)` - Directional rose diagram
- `fetch_app(fetch_data)` - Interactive Shiny app with Leaflet map
- `fetch_app_upload()` - Shiny app with file upload interface

### Configuration
- `lakefetch_options(...)` - Get/set package options
- `lakefetch_reset_options()` - Reset to defaults

## Configuration Options

```r
lakefetch_options(
  buffer_distance_m = 10,       # GPS accuracy buffer (nudge points inward)
  angle_resolution_deg = 5,     # Ray-casting resolution in degrees
  max_fetch_m = 50000,          # Maximum fetch distance
  validation_buffer_m = 10,     # Shore detection validation
  default_wind_speed_ms = 10,   # Default wind for orbital velocity
  default_depth_m = 10,         # Default depth for wave calcs
  gps_tolerance_m = 100,        # Buffer for matching sites to lakes
  use_parallel = TRUE,          # Parallel processing for multi-lake
  use_nhd = TRUE                # Enable NHD integration
)
```

## Output Columns

Fetch results include:
- `fetch_0`, `fetch_5`, ..., `fetch_355` - Directional fetch in meters
- `fetch_mean` - Average fetch across all directions
- `fetch_max` - Maximum fetch distance
- `fetch_effective` - Mean of top 3 fetch values
- `orbital_effective` - Estimated wave orbital velocity (m/s)
- `exposure_category` - "Sheltered" (<2.5km), "Moderate" (2.5-5km), "Exposed" (>km)
- `lake_osm_id`, `lake_name`, `lake_area_km2` - Lake identifiers

With NHD context:
- `outlet_dist_m`, `outlet_bearing` - Distance/direction to outlet
- `inlet_nearest_dist_m`, `inlet_count` - Inlet information
- `connectivity_class` - Headwater/Drainage/Terminal/Isolated
- `watershed_area_ha`, `lake_watershed_ratio`

With weather context:
- `wind_mean_24h`, `wind_max_3d`, etc. - Wind statistics
- `wave_energy_24h`, `wave_height_max_3d` - Cumulative wave metrics
- `temp_mean_24h`, `precip_total_3d` - Other weather variables

## Dependencies

**Required:**
- `sf` - Spatial operations
- `osmdata` - OpenStreetMap data download
- `ggplot2` - Static visualizations

**Suggested:**
- `nhdplusTools` - NHD integration
- `jsonlite` - Weather API calls
- `shiny`, `leaflet`, `viridis` - Interactive app
- `base64enc` - Rose plot embedding in popups
- `parallel` - Multi-lake parallel processing
- `testthat` - Unit testing

## Testing

### Unit Tests (testthat)

Run the full test suite:
```r
devtools::test()
```

**79 tests across 4 test files:**
- `test-fetch_core.R` (18 tests) - Analytical validation against known geometries
- `test-data_loading.R` (25 tests) - Input handling and column detection
- `test-options.R` (24 tests) - Configuration management
- `test-visualization.R` (12 tests) - Plotting functions

### Analytical Validation

Run standalone validation:
```r
source("inst/validation/validate_fetch.R")
```

**Validation tests (4/4 passed with 0% error):**
1. **Circular lake center** - Fetch equals radius in all directions
2. **Circular lake edge** - Fetch ranges from ~0 to diameter
3. **Rectangular lake** - Cardinal directions match half-width/height
4. **Effective fetch** - Mean of top 3 matches expected values

### R CMD Check

```r
devtools::check(build_args = '--no-build-vignettes')
```

**Status: CRAN-ready**
- 0 errors
- 0 warnings
- 1 note (system time check - ignorable for CRAN submission)

## Development

### Rebuilding Documentation
```r
devtools::document()  # Regenerates man/ and NAMESPACE from roxygen2 comments
```

### Running Tests
```r
devtools::test()      # Run testthat suite
devtools::check()     # Full R CMD check
```

### Building Package
```r
devtools::build()
devtools::install()
```

## Common Tasks

### Process Multiple Lakes
Sites spanning multiple lakes are handled automatically. Each site is assigned to its containing lake polygon via spatial intersection. If spatial matching fails, name-based matching is attempted using the `lake.name` column.

### Custom Lake Boundaries
For lakes not well-represented in OSM, provide a shapefile or geopackage:
```r
lake <- get_lake_boundary(sites, file = "my_lake.shp")
```

### Add Weather-Based Wave Energy
Requires datetime column in site data:
```r
results$results <- add_weather_context(results$results, datetime_col = "datetime")
```

### Export Results
```r
# CSV (no geometry)
write.csv(sf::st_drop_geometry(results$results), "results.csv")

# GeoPackage (with geometry)
sf::st_write(results$results, "results.gpkg")
```

## OSM Download Reliability

The package uses multiple Overpass API servers with automatic failover:
1. `overpass-api.de` (primary)
2. `kumi.systems` (fallback)
3. `maps.mail.ru` (fallback)

If one server returns HTTP 500 or times out, the package automatically retries with the next server. This provides robust lake boundary downloads even during periods of high API load.

## Lake Matching Strategy

Sites are matched to lakes using a multi-step approach:
1. **Spatial intersection** - Point-in-polygon with GPS tolerance buffer (100m)
2. **Name-based matching** - If `lake.name` column exists, matches against OSM lake names
3. **Diagnostic messages** - Reports matched/unmatched sites for troubleshooting

## Known Limitations

- **HydroLAKES integration disabled** - The hydrolinks package is not available on CRAN for R 4.4.x; depth estimation falls back to empirical relationships
- **OSM data quality varies** - Some small lakes may not be in OpenStreetMap
- **NHD integration US-only** - National Hydrography Dataset covers only the United States
- **Cross-package validation blocked** - waver (coastal focus) and fetchR (not available for R 4.4.x) have compatibility issues

## Roadmap

See `TODO.md` for the complete development roadmap including:
- Validation against published literature
- Edge case testing (islands, complex shorelines)
- JOSS methods paper
- Additional vignettes
- CRAN submission

## Notes

- All spatial operations use UTM projection (auto-detected from site coordinates)
- S2 spherical geometry is temporarily disabled during OSM queries to avoid topology errors
- Weather data comes from Open-Meteo API (free, no registration required)
- The package caches nudged positions and fetch calculations for duplicate coordinates
